# zlua

## 目标

* 基于lua重新设计和实现一门脚本语言
* 完全符合c#编程规范
* 完全替代unity编程的c#脚本
  1. 兼容一些C#的特性，比如ref，out
  2. 导入unity的库和c#标准库
  3. 游戏逻辑和游戏数据的热更新
* 学习和启发用，以我目前的知识水平难以做出成品

## 开发过程

这个项目我从2018年3月初开始做，一开始看《游戏脚本高级编程》，写了一个xasm的汇编器+虚拟机，然后学编译原理，然后下定决心打算写一个带有编译器性质的东西，最后锁定在lua上，这中间有很多原因，不讲。

暑假继续这个项目，几天后想法有一些改变，在对这个项目的各个方面都有了解的基础上确定了目标。

### 暑假前

* 学习如何写lua代码，lua的基本语法等
* zhihu上有一个人实现了C#的lua解释器（unilua），并写了两篇文章，看掉；看他的解释器代码，没有任何注释和手册，卒
* github上找C#的lua解释器，选择了Kopilua，看不懂，后来知道是lua源代码的直接翻译，所以直接看lua源代码
* 看lua源代码，看不懂，卒
* 找到一本书《lua设计与实现》，配合着看了一点lua源代码，看懂了一些部分
* 阅读lua相关论文
* 在这个时候，我觉得自己大概写不了一个前端的解析器，本来是把项目目标定为后端虚拟机实现
* 然而我知道了antlr，花一周学习
* 花一周写一个一个前端，代码生成的时候卡住了，不知道该怎么写，lua源代码看不懂，而且用了antlr就要靠自己想了
* 知道了栈式虚拟机比寄存器式简单，了解了一下，自己yy了一个代码生成，把前端和后端虚拟机接上了
* 虚拟机怎么实现的呢？前面写的汇编器+虚拟机时，把框架保留重新写的（汇编器+虚拟机写的是xasm这个汇编语言的解释器）
* 到此为止python实现能正确执行，这个时候是五月九号
* 另外一条线的C#版本从四月十七号开始写data model，然后把antlr配置上去，五月十一号写完，包括实验报告
* 这个项目就算暂时结束了，因为花费了太长时间
* 后面复盘了两次，修改了一些bug

### 暑假中

* 迷茫了几天，新开了基本编译原理的书，龙书买了英文版也是比较难读
* 确定了方法，减小问题规模，并且自底而上。先写个伪的代码生成器喂给vm，逐步实现vm和lua manual的index中列出的API。这种方法比东一下西一下好很多。自己还做了放弃GC，协程，闭包的决定。很多事情很难想通，比如语言到底要有什么。因为看不到全局，怕放弃太多最后做不出来。现在基本没这个困惑了。

### 其他想法

* 不必完整学习lua源代码，自己yy一个“问题的解”，原因是lua源代码并不好读，这至少是我的判断，我不再相信网上和书上说的“lua源代码清晰易读”。
* 这个原因是我不会用xlua和slua。嗯，可能学这两个比自己写简单吧。或许没必要自己造轮子的吧。我是有一点困惑的。
